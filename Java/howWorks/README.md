# 자바는 어떻게 돌아가나?
## JVM
- java 파일을 컴파일하면 class 파일(바이트코드)가 나온다.
- 위의 바이트 코드를 기계에 맞게 돌려주는 역할을 함
- 바이트 코드를 실행하는 표준이자 구현체를 지칭
- 이 표준에 맞는 언어를 구동하는 환경도 제공된다.(코틀린, 스칼라 등)
- javap -c {클래스파일명} <- 이 명령어를 통해 바이트코드를 볼 수 있다.

## JRE
- JVM + 라이브러리
- 자바 애플리케이션을 실행할 수 있도록 구성된 배포판.
- 핵심 라이브러리가 포함되어 있다는 게 특징
- 개발툴(javac 같은 거)는 엄슴.
- 이건 말 그대로 '실행'만을 위한 녀석
- 이제는 역사의 뒤안길로(요즘은 별 구분 없다)

## JDK
- JRE + 개발툴

## JVM 구조 (jvmStructure)
### 1. 클래스 로더 시스템
- .class에서 바이트코드를 읽고 메모리에 저장
- 로딩: 클래스를 읽어옴
- 링크: 레퍼런스 연결
- 초기화: static 값 초기화 + 변수 할당

### 2. 메모리
- 공유 자원: 메소드, 힙
- 스레드 단위 공유: 스택, PC, 네이티브 메소드 스택

#### 2.1 메소드
- 클래스 수준의 정보를 저장한다.
- 클래스 이름, 부모 클래스 이름, 메소드, 변수 저장한다는 얘기다
- 공유되는 자원임

#### 2.2 힙
- 객체를 저장
- 공유되는 자원임

#### 2.3 스택
- 스레드마다 런타임 스택을 만들어줌
- 요 안에다 메소드 호출을 스택 프레임이라는 블럭으로 쌓아놓는다.
- 당연히 스레드 죽으면 런타임 스택도 사라진다.

#### 2.4 PC
- 스레드마다 생겨남
- 현재 실행할 스택 프레임이 누구인지 알려주는 녀석

#### 2.5 네이티브 메소드 스택
- 얘도 스래드마다 생겨남
- 네이티브 메소드를 사용할 때 쌓인다.
    - 네이티브 메소드: C나 C++로 만들어진 놈들. native 키워드가 붙어있다.
- 실행 엔진, 네이티브 메소드 인터페이스와 메모리 영역을 연결시켜준다.

## 바이트코드 조작
### 1. 코드 커버리지는 어떻게 측정 가능한가? (codecoverage package)
- 예제 코드 하나 작성 + 자코코 동작 알아보쟈
- Maven을 통해 플러그인 설정해주고 테스트 동작시키면 target 폴더 내에 코드 커버리지 생김
- 이런 애들은 도대체 내 코드가 어떻게 생겼는지 어떻게 알까?
- 바이트 코드를 분석해서 지나가는 부분들을 모두 기록함
- 실제 동작할 때 기록한 부분을 건드렸는지 확인함
- 자세한 건 논문 참조..

### 2. 모자에서 토끼 꺼내보자! (rabbitmagic package)
- 자바 코드와 관계 없이 조작을 해보자
- ASM을 통해 사용 가능(보기 좀 개 구리다..)
- javassist를 통해서도 사용 가능(ASM보다 낫지만 여전히 구리다)
- ByteBuddy를 사용하는 걸 추천
- 소스코드와 무관하게 코드를 조작할 수 있다.
- 다만, 소스코드 안에서 조작하면 순서에 따라 안될 수도 있기 때문에 Java Agent를 사용한다.
- premain 함수를 통해 jar 파일 agent 생성
- 실행 vm 환경에 -javaagent:{agentFile} 옵션을 추가해서 실행해준다.
- 실행 전에 끼어들어서 바이트코드를 슬쩍 바꾸고 사라진다.

### 3. 그래서 어따 쓰지?
- 성능분석(프로파일러), 최적화, 로깅 등등
- 사실상 못하는 거 빼고 다 할 수 있다
- Spring의 컴포넌트 스캔에서도 사용한다. (ASM으로 스캔 후보를 선출함)
- 프록시를 만들 때도 많이 씀 (AOP, Mockito, JPA 지연 로딩)
- ASM, Javassist, ByteBuddy 등을 보면 힌트를 얻을 수 있을 것

## 리플렉션
- 객체의 생성부터 변경까지 모두 관여한다.
- 원하는 객체의 class 타입을 받아서 리플렉션 할 수 있다.
- 워낙 강력한 기능인 만큼 잘 설계해서 잘 사용해야 한다.
- Spring이 대표적인 예시

## Dynamic Proxy
- 리플렉션의 일부(특수한 용도로 사용됨)
- 객체는 이미 생성된 상태에서 해당 객체를 어떻게 다룰 것인가에 관한 문제
- JPA가 대표적인 예시 
